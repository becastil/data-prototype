version: 1
env:
  variables:
    NODE_OPTIONS: "--max-old-space-size=8192"
    NEXT_TELEMETRY_DISABLED: 1
    NODE_ENV: production
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 20
        - |
          if [ "$AWS_BRANCH" = "production" ]; then
            echo "NEXT_PUBLIC_API_URL=$HEALTHCARE_API_URL_PROD" >> .env.production.local
            echo "NEXT_PUBLIC_ENVIRONMENT=production" >> .env.production.local
          elif [ "$AWS_BRANCH" = "staging" ]; then
            echo "NEXT_PUBLIC_API_URL=$HEALTHCARE_API_URL_STAGING" >> .env.production.local
            echo "NEXT_PUBLIC_ENVIRONMENT=staging" >> .env.production.local
          else
            echo "NEXT_PUBLIC_ENVIRONMENT=development" >> .env.production.local
          fi
        - echo "Node heap limit = $(node -e 'console.log(require(\"v8\").getHeapStatistics().heap_size_limit / (1024 * 1024))')Mb"
    build:
      commands:
        - npm run build:amplify
    postBuild:
      commands:
        - echo "Build completed at $(date)"
        - du -sh .next
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm/**/*
customHeaders:
  - pattern: '**'
    headers:
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains; preload'
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'Content-Security-Policy'
        value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'wasm-unsafe-eval'; script-src-elem 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; style-src-elem 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://*.amazonaws.com https://vitals.vercel-insights.com; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests"
      - key: 'Permissions-Policy'
        value: 'camera=(), microphone=(), geolocation=()'
  - pattern: '**/*.js'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  - pattern: '**/*.css'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  - pattern: '/api/**'
    headers:
      - key: 'Cache-Control'
        value: 's-maxage=300, stale-while-revalidate=600'
